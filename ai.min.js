/*!
 * BYLICKILABS â€“ AI Monitoring Layer (ai.js)
 * Version: 1.1.1
 *
 * Features:
 *  - Error & Promise Monitoring
 *  - Network Monitoring (fetch + XHR)
 *  - Resource Load Errors
 *  - Performance & FPS Tracking
 *  - Offline Event Queue Marking
 *  - AI Scoring 1.0 (Errors, Network, Resources, FPS, Performance)
 *  - Local Log Storage (Ring-Buffer)
 *  - Incident Report Export
 *  - Screenshot Export (optional, via html2canvas wenn vorhanden)
 *  - UI-Overlay mit Status, Export & Clear
 */
!function(e,t){if(!e||!t)return;const r={appName:"Ai Monitoring Layer",appVersion:"1.0.0",environment:"production",storageKey:"BYLICKILABS_AI_LOGS",maxLogEntries:800,ui:{enabled:!0,position:"bottom-right"},thresholds:{errorRateHigh:.1,slowLoadMs:3e3,minEventsForAnalysis:20,networkErrorRateWarn:.25,networkErrorRateCrit:.5,resourceErrorWarn:10,resourceErrorCrit:30,fpsWarn:25,fpsCrit:15,fpsWindowSeconds:30}},n={logs:[],counters:{totalEvents:0,errors:0,warnings:0,info:0},performance:{pageLoadTime:null,fpsSamples:[],fpsLastTime:null,fpsAverage:null,fpsLowFrames:0,fpsWindowStart:null,firstAnalysisDone:!1},network:{totalRequests:0,errorCount:0,lastErrors:[],isOffline:!navigator.onLine},resources:{errorCount:0},anomaly:{level:"normal",reasons:[]},initialized:!1};function nowISO(){return(new Date).toISOString()}function safeStringify(e){try{return JSON.stringify(e,null,2)}catch(t){return"{}"}}function persistToStorage(){try{const t=n.logs.slice(-r.maxLogEntries);e.localStorage.setItem(r.storageKey,JSON.stringify(t))}catch(t){}}function createLog(t,o,s,a){return{timestamp:nowISO(),app:r.appName,version:r.appVersion,env:r.environment,type:t,level:o,message:s||"",details:a||{},userAgent:navigator.userAgent||"",url:e.location.href||"",offline:!0===n.network.isOffline}}function addLog(e){switch(n.logs.push(e),n.counters.totalEvents++,e.level){case"error":n.counters.errors++;break;case"warn":n.counters.warnings++;break;case"info":n.counters.info++}n.logs.length>r.maxLogEntries&&(n.logs=n.logs.slice(-r.maxLogEntries)),persistToStorage(),runAnomalyAnalysis(),updateUIStatus()}function runAnomalyAnalysis(){const e=[];let t="normal";const o=n.counters.totalEvents||0,s=n.counters.errors||0,a=n.network.totalRequests||0,i=n.network.errorCount||0,l=n.resources.errorCount||0,c=n.performance.fpsAverage,p=n.performance.pageLoadTime;if(o>=r.thresholds.minEventsForAnalysis&&o>0){const n=s/o;n>=2*r.thresholds.errorRateHigh?(t="critical",e.push(`Hohe JS-Fehlerrate: ${(100*n).toFixed(1)}%`)):n>=r.thresholds.errorRateHigh&&("critical"!==t&&(t="warning"),e.push(`ErhÃ¶hte JS-Fehlerrate: ${(100*n).toFixed(1)}%`))}if(null!=p&&(p>2*r.thresholds.slowLoadMs?(t="critical",e.push(`Sehr langsame Page-Load-Zeit: ${p} ms`)):p>r.thresholds.slowLoadMs&&("critical"!==t&&(t="warning"),e.push(`Langsame Page-Load-Zeit: ${p} ms`))),a>0){const n=i/a;n>=r.thresholds.networkErrorRateCrit?(t="critical",e.push(`Hohe Netzwerkfehler-Rate: ${(100*n).toFixed(1)}% (${i}/${a})`)):n>=r.thresholds.networkErrorRateWarn&&("critical"!==t&&(t="warning"),e.push(`ErhÃ¶hte Netzwerkfehler-Rate: ${(100*n).toFixed(1)}% (${i}/${a})`))}if(l>=r.thresholds.resourceErrorCrit?(t="critical",e.push(`Viele fehlgeschlagene Ressourcen-LadevorgÃ¤nge: ${l} Fehler`)):l>=r.thresholds.resourceErrorWarn&&("critical"!==t&&(t="warning"),e.push(`AuffÃ¤llige Anzahl an Ressourcen-Ladefehlern: ${l} Fehler`)),null!=c&&(c<=r.thresholds.fpsCrit?(t="critical",e.push(`Sehr niedrige Rendering-Performance: ~${c.toFixed(1)} FPS`)):c<=r.thresholds.fpsWarn&&("critical"!==t&&(t="warning"),e.push(`Niedrige Rendering-Performance: ~${c.toFixed(1)} FPS`))),n.anomaly.level=t,n.anomaly.reasons=e,!n.performance.firstAnalysisDone&&e.length>0){const r=createLog("anomaly","critical"===t?"error":"warn","AI-Anomaly-Engine hat AuffÃ¤lligkeiten erkannt.",{reasons:e,summary:getAnomalySummary()});n.performance.firstAnalysisDone=!0,n.logs.push(r),n.counters.totalEvents++,n.counters["error"===r.level?"errors":"warnings"]++,persistToStorage()}}function getAnomalySummary(){return{level:n.anomaly.level,reasons:n.anomaly.reasons.slice(),stats:{totalEvents:n.counters.totalEvents,errors:n.counters.errors,warnings:n.counters.warnings,info:n.counters.info,pageLoadTime:n.performance.pageLoadTime,fpsAverage:n.performance.fpsAverage,fpsLowFrames:n.performance.fpsLowFrames,networkTotal:n.network.totalRequests,networkErrors:n.network.errorCount,resourceErrors:n.resources.errorCount,offline:n.network.isOffline}}}function captureInitialPerformance(){try{let e=null;if(performance&&performance.getEntriesByType){const t=performance.getEntriesByType("navigation");t&&t.length>0&&(e=Math.round(t[0].duration))}if(!e&&performance&&performance.timing){const t=performance.timing;e=Math.round((t.loadEventEnd||t.domComplete||0)-t.navigationStart)}if(e&&e>0&&e<6e4){n.performance.pageLoadTime=e;addLog(createLog("performance","info","Initiale Page-Load-Messung.",{loadTimeMs:e}))}}catch(e){}}function startFPSTracking(){try{const o=e.performance;if(!o||!o.now||!e.requestAnimationFrame)return;function loop(){try{const e=o.now(),t=e-n.performance.fpsLastTime;if(n.performance.fpsLastTime=e,t>0&&t<1e3){const o=1e3/t;n.performance.fpsSamples.push(o);const s=(e-n.performance.fpsWindowStart)/1e3;if(o<r.thresholds.fpsWarn&&n.performance.fpsLowFrames++,s>=r.thresholds.fpsWindowSeconds){const t=n.performance.fpsSamples;if(t.length>0){const e=t.reduce(((e,t)=>e+t),0);n.performance.fpsAverage=e/t.length}n.performance.fpsSamples=[],n.performance.fpsWindowStart=e;addLog(createLog("performance","info","FPS-Window-Analyse abgeschlossen.",{fpsAverage:n.performance.fpsAverage,fpsLowFrames:n.performance.fpsLowFrames,windowSeconds:r.thresholds.fpsWindowSeconds}))}}}catch(t){}e.requestAnimationFrame(loop)}n.performance.fpsWindowStart=o.now(),n.performance.fpsLastTime=o.now(),e.requestAnimationFrame(loop)}catch(t){}}let o=0;const s=300;function getLogs(){return n.logs.slice()}function clearLogs(){n.logs=[],n.counters.totalEvents=0,n.counters.errors=0,n.counters.warnings=0,n.counters.info=0,persistToStorage(),runAnomalyAnalysis(),updateUIStatus()}function exportLogs(){const e={exportedAt:nowISO(),app:r.appName,version:r.appVersion,env:r.environment,anomaly:getAnomalySummary(),logs:getLogs()};downloadBlob(JSON.stringify(e,null,2),"application/json","bylickilabs-ai-logs")}function exportIncidentReport(){const e=getAnomalySummary(),t={generatedAt:nowISO(),app:r.appName,version:r.appVersion,env:r.environment,summary:e,lastNetworkErrors:n.network.lastErrors,lastEvents:getLogs().slice(-50)};downloadBlob(JSON.stringify(t,null,2),"application/json","bylickilabs-incident-report")}function downloadBlob(e,r,n){try{const o=new Blob([e],{type:r}),s=URL.createObjectURL(o),a=t.createElement("a"),i=(new Date).toISOString().replace(/[:.]/g,"-");a.href=s,a.download=`${n}-${i}.json`,t.body.appendChild(a),a.click(),t.body.removeChild(a),URL.revokeObjectURL(s)}catch(o){try{console.error("[BYLICKILABS AI] Download fehlgeschlagen:",o)}catch(s){}}}function captureScreenshot(){try{"function"==typeof e.html2canvas?e.html2canvas(t.body).then((function(e){e.toBlob((function(e){if(!e)return;const r=URL.createObjectURL(e),n=t.createElement("a"),o=(new Date).toISOString().replace(/[:.]/g,"-");n.href=r,n.download=`bylickilabs-ai-screenshot-${o}.png`,t.body.appendChild(n),n.click(),t.body.removeChild(n),URL.revokeObjectURL(r)}),"image/png")})):alert("Screenshot-Export benÃ¶tigt 'html2canvas'. Bitte Bibliothek laden oder alternativ Browser-Screenshots verwenden.")}catch(r){try{console.error("[BYLICKILABS AI] Screenshot-Export fehlgeschlagen",r)}catch(n){}}}let a=null,i=null;function createUI(){if(!r.ui.enabled)return;if(!t.body)return;a=t.createElement("div"),a.id="bylickilabs-ai-monitor",a.style.position="fixed",a.style.zIndex="99999",a.style.fontFamily="system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif",a.style.fontSize="12px",a.style.color="#e5e5e5",a.style.background="rgba(10,10,20,0.92)",a.style.borderRadius="10px",a.style.boxShadow="0 0 18px rgba(0,0,0,0.6)",a.style.padding="8px 10px",a.style.minWidth="210px",a.style.backdropFilter="blur(6px)",a.style.border="1px solid rgba(120,120,255,0.45)",a.style.display="flex",a.style.flexDirection="column",a.style.gap="6px","bottom-left"===r.ui.position?(a.style.left="12px",a.style.bottom="12px"):(a.style.right="12px",a.style.bottom="12px");const e=t.createElement("div");e.style.display="flex",e.style.justifyContent="space-between",e.style.alignItems="center",e.style.gap="8px";const n=t.createElement("div");n.textContent="AI Monitoring",n.style.fontWeight="600",n.style.letterSpacing="0.03em",i=t.createElement("span"),i.textContent="NORMAL",i.style.fontSize="10px",i.style.padding="2px 6px",i.style.borderRadius="999px",i.style.background="rgba(50,200,120,0.18)",i.style.border="1px solid rgba(50,200,120,0.65)",i.style.color="#b7f5d2",e.appendChild(n),e.appendChild(i);const o=t.createElement("div");o.style.fontSize="11px",o.style.opacity="0.9",o.innerHTML='<span id="bl-ai-events">Events: 0</span> Â· <span id="bl-ai-errors">Errors: 0</span> Â· <span id="bl-ai-neterr">NetErr: 0</span>';const s=t.createElement("div");s.style.display="flex",s.style.gap="6px",s.style.marginTop="2px";const l=t.createElement("div");function makeButton(e){const r=t.createElement("button");return r.type="button",r.textContent=e,r.style.flex="1",r.style.cursor="pointer",r.style.border="none",r.style.borderRadius="6px",r.style.padding="4px 6px",r.style.fontSize="11px",r.style.background="rgba(80,80,200,0.22)",r.style.color="#f3f3ff",r.style.transition="background 0.15s ease, transform 0.1s ease",r.onmouseenter=function(){r.style.background="rgba(120,120,255,0.38)"},r.onmouseleave=function(){r.style.background="rgba(80,80,200,0.22)",r.style.transform="scale(1.0)"},r.onmousedown=function(){r.style.transform="scale(0.97)"},r.onmouseup=function(){r.style.transform="scale(1.0)"},r}l.style.display="flex",l.style.gap="6px";const c=makeButton("ðŸ“„ Export Logs");c.addEventListener("click",exportLogs);const p=makeButton("ðŸ“‘ Incident");p.addEventListener("click",exportIncidentReport);const d=makeButton("ðŸ“· Screenshot");d.addEventListener("click",captureScreenshot);const u=makeButton("ðŸ§¹ Clear");u.addEventListener("click",clearLogs),s.appendChild(c),s.appendChild(p),l.appendChild(d),l.appendChild(u),a.appendChild(e),a.appendChild(o),a.appendChild(s),a.appendChild(l),t.body.appendChild(a),updateUIStatus()}function updateUIStatus(){if(!a||!i)return;const e=a.querySelector("#bl-ai-events"),t=a.querySelector("#bl-ai-errors"),r=a.querySelector("#bl-ai-neterr");e&&(e.textContent=`Events: ${n.counters.totalEvents}`),t&&(t.textContent=`Errors: ${n.counters.errors}`),r&&(r.textContent=`NetErr: ${n.network.errorCount}`);const o=n.anomaly.level;"critical"===o?(i.textContent="CRITICAL",i.style.background="rgba(220,30,80,0.22)",i.style.border="1px solid rgba(255,80,120,0.8)",i.style.color="#ffd6e0"):"warning"===o?(i.textContent="WARNING",i.style.background="rgba(240,180,50,0.22)",i.style.border="1px solid rgba(255,210,80,0.9)",i.style.color="#fff4cf"):(i.textContent="NORMAL",i.style.background="rgba(50,200,120,0.18)",i.style.border="1px solid rgba(50,200,120,0.65)",i.style.color="#b7f5d2")}function init(){if(n.initialized)return;n.initialized=!0,function loadFromStorage(){try{const t=e.localStorage.getItem(r.storageKey);if(!t)return;const o=JSON.parse(t);Array.isArray(o)&&(n.logs=o,n.counters.totalEvents=o.length,n.counters.errors=o.filter((e=>"error"===e.level)).length,n.counters.warnings=o.filter((e=>"warn"===e.level)).length,n.counters.info=o.filter((e=>"info"===e.level)).length)}catch(t){}}(),function setupErrorMonitoring(){e.addEventListener("error",(function(t){try{if(t.target&&t.target!==e&&t.target.tagName){const e=t.target,r=e.tagName,o=e.src||e.href||"";return n.resources.errorCount++,void addLog(createLog("resource","warn","Ressource konnte nicht geladen werden.",{tag:r,src:o,outerHTML:(e.outerHTML||"").slice(0,300)}))}const r=t.error||{};addLog(createLog("error","error","Unhandled JavaScript Error.",{message:t.message||r.message||"",file:t.filename||"",line:t.lineno||null,column:t.colno||null,stack:r.stack||""}))}catch(r){}}),!0),e.addEventListener("unhandledrejection",(function(e){try{const t=e.reason||{};addLog(createLog("error","error","Unhandled Promise Rejection.",{message:t.message||safeStringify(t),stack:t.stack||""}))}catch(t){}}))}(),function setupEventMonitoring(){t.addEventListener("click",(function(e){try{const t=Date.now();if(t-o<s)return;o=t;const r=e.target||{};addLog(createLog("event","info","User Click Event.",{element:{tag:r.tagName||"",id:r.id||"",classes:r.className||"",textSnippet:(r.innerText||r.textContent||"").slice(0,50)}}))}catch(t){}}),!0),e.addEventListener("offline",(function(){n.network.isOffline=!0,addLog(createLog("system","warn","Browser ist offline gegangen.",{}))})),e.addEventListener("online",(function(){n.network.isOffline=!1,addLog(createLog("system","info","Browser ist wieder online.",{}))}))}(),function setupNetworkMonitoring(){try{if(e.fetch){const r=e.fetch;e.fetch=function(){const e=performance&&performance.now?performance.now():Date.now();return n.network.totalRequests++,r.apply(this,arguments).then((function(t){const r=(performance&&performance.now?performance.now():Date.now())-e;return t.ok||(n.network.errorCount++,addLog(createLog("network","warn","HTTP-Fehler bei fetch().",{url:t.url,status:t.status,statusText:t.statusText,durationMs:Math.round(r),method:arguments[1]&&arguments[1].method||"GET"}))),t}))["catch"]((function(e){throw n.network.errorCount++,addLog(createLog("network","error","fetch() ist mit einem Netzwerkfehler fehlgeschlagen.",{message:e&&e.message?e.message:String(e),stack:e&&e.stack?e.stack:"",requestInfo:arguments[0]})),e}))}}if(e.XMLHttpRequest){const o=e.XMLHttpRequest;function WrappedXHR(){const e=new o;let t="",r="GET",s=null;const a=e.open;e.open=function(n,o){return r=n||"GET",t=o||"",a.apply(e,arguments)};const i=e.send;return e.send=function(){return n.network.totalRequests++,s=performance&&performance.now?performance.now():Date.now(),e.addEventListener("loadend",(function(){try{const o=(performance&&performance.now?performance.now():Date.now())-s;(e.status>=400||0===e.status)&&(n.network.errorCount++,addLog(createLog("network","warn","HTTP-Fehler bei XMLHttpRequest.",{url:t,status:e.status,statusText:e.statusText,method:r,durationMs:Math.round(o)})))}catch(o){}})),i.apply(e,arguments)},e}e.XMLHttpRequest=WrappedXHR}}catch(t){}}(),"complete"===t.readyState?(captureInitialPerformance(),startFPSTracking(),createUI()):e.addEventListener("load",(function(){captureInitialPerformance(),startFPSTracking(),createUI()}));addLog(createLog("system","info","BYLICKILABS AI Monitoring v1.1 initialisiert.",{config:{appName:r.appName,env:r.environment}}))}const l={config:r,init:init,getLogs:getLogs,clearLogs:clearLogs,exportLogs:exportLogs,exportIncidentReport:exportIncidentReport,captureScreenshot:captureScreenshot,getAnomalySummary:getAnomalySummary,logCustom:function(e,t,r){addLog(createLog("custom",e||"info",t||"",r||{}))}};e.BYLICKILABS_AI_MONITOR=l,init()}(window,document);
